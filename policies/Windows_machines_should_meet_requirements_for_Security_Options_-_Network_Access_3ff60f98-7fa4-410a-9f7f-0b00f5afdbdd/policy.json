{
 "properties": {
  "displayName": "Windows machines should meet requirements for 'Security Options - Network Access'",
  "policyType": "BuiltIn",
  "mode": "Indexed",
  "description": "Windows machines should have the specified Group Policy settings in the category 'Security Options - Network Access' for including access for anonymous users, local accounts, and remote access to the registry. This policy requires that the Guest Configuration prerequisites have been deployed to the policy assignment scope. For details, visit https://aka.ms/gcpol.",
  "metadata": {
   "category": "Guest Configuration",
   "version": "3.0.0",
   "requiredProviders": [
    "Microsoft.GuestConfiguration"
   ],
   "guestConfiguration": {
    "name": "AzureBaseline_SecurityOptionsNetworkAccess",
    "version": "1.*",
    "configurationParameter": {
     "NetworkAccessRemotelyAccessibleRegistryPaths": "Network access: Remotely accessible registry paths;ExpectedValue",
     "NetworkAccessRemotelyAccessibleRegistryPathsAndSubpaths": "Network access: Remotely accessible registry paths and sub-paths;ExpectedValue",
     "NetworkAccessSharesThatCanBeAccessedAnonymously": "Network access: Shares that can be accessed anonymously;ExpectedValue"
    }
   }
  },
  "parameters": {
   "IncludeArcMachines": {
    "type": "String",
    "metadata": {
     "displayName": "Include Arc connected servers",
     "description": "By selecting this option, you agree to be charged monthly per Arc connected machine.",
     "portalReview": "true"
    },
    "allowedValues": [
     "true",
     "false"
    ],
    "defaultValue": "false"
   },
   "NetworkAccessRemotelyAccessibleRegistryPaths": {
    "type": "String",
    "metadata": {
     "displayName": "Network access: Remotely accessible registry paths",
     "description": "Specifies which registry paths will be accessible over the network, regardless of the users or groups listed in the access control list (ACL) of the `winreg` registry key."
    },
    "defaultValue": "System\\CurrentControlSet\\Control\\ProductOptions|#|System\\CurrentControlSet\\Control\\Server Applications|#|Software\\Microsoft\\Windows NT\\CurrentVersion"
   },
   "NetworkAccessRemotelyAccessibleRegistryPathsAndSubpaths": {
    "type": "String",
    "metadata": {
     "displayName": "Network access: Remotely accessible registry paths and sub-paths",
     "description": "Specifies which registry paths and sub-paths will be accessible over the network, regardless of the users or groups listed in the access control list (ACL) of the `winreg` registry key."
    },
    "defaultValue": "System\\CurrentControlSet\\Control\\Print\\Printers|#|System\\CurrentControlSet\\Services\\Eventlog|#|Software\\Microsoft\\OLAP Server|#|Software\\Microsoft\\Windows NT\\CurrentVersion\\Print|#|Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows|#|System\\CurrentControlSet\\Control\\ContentIndex|#|System\\CurrentControlSet\\Control\\Terminal Server|#|System\\CurrentControlSet\\Control\\Terminal Server\\UserConfig|#|System\\CurrentControlSet\\Control\\Terminal Server\\DefaultUserConfiguration|#|Software\\Microsoft\\Windows NT\\CurrentVersion\\Perflib|#|System\\CurrentControlSet\\Services\\SysmonLog"
   },
   "NetworkAccessSharesThatCanBeAccessedAnonymously": {
    "type": "String",
    "metadata": {
     "displayName": "Network access: Shares that can be accessed anonymously",
     "description": "Specifies which network shares can be accessed by anonymous users. The default configuration for this policy setting has little effect because all users have to be authenticated before they can access shared resources on the server."
    },
    "defaultValue": "0"
   },
   "effect": {
    "type": "String",
    "metadata": {
     "displayName": "Effect",
     "description": "Enable or disable the execution of this policy"
    },
    "allowedValues": [
     "AuditIfNotExists",
     "Disabled"
    ],
    "defaultValue": "AuditIfNotExists"
   }
  },
  "policyRule": {
   "if": {
    "anyOf": [
     {
      "allOf": [
       {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
       },
       {
        "anyOf": [
         {
          "field": "Microsoft.Compute/imagePublisher",
          "in": [
           "esri",
           "incredibuild",
           "MicrosoftDynamicsAX",
           "MicrosoftSharepoint",
           "MicrosoftVisualStudio",
           "MicrosoftWindowsDesktop",
           "MicrosoftWindowsServerHPCPack"
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "MicrosoftWindowsServer"
           },
           {
            "field": "Microsoft.Compute/imageSKU",
            "notLike": "2008*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "MicrosoftSQLServer"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "notLike": "SQL2008*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "microsoft-dsvm"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "like": "dsvm-win*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "microsoft-ads"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "in": [
             "standard-data-science-vm",
             "windows-data-science-vm"
            ]
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "batch"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "equals": "rendering-windows2016"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "center-for-internet-security-inc"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "like": "cis-windows-server-201*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "pivotal"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "like": "bosh-windows-server*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "cloud-infrastructure-services"
           },
           {
            "field": "Microsoft.Compute/imageOffer",
            "like": "ad*"
           }
          ]
         },
         {
          "allOf": [
           {
            "anyOf": [
             {
              "field": "Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration",
              "exists": "true"
             },
             {
              "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
              "like": "Windows*"
             }
            ]
           },
           {
            "anyOf": [
             {
              "field": "Microsoft.Compute/imageSKU",
              "exists": "false"
             },
             {
              "allOf": [
               {
                "field": "Microsoft.Compute/imageSKU",
                "notLike": "2008*"
               },
               {
                "field": "Microsoft.Compute/imageOffer",
                "notLike": "SQL2008*"
               }
              ]
             }
            ]
           }
          ]
         }
        ]
       }
      ]
     },
     {
      "allOf": [
       {
        "value": "[parameters('IncludeArcMachines')]",
        "equals": "true"
       },
       {
        "anyOf": [
         {
          "allOf": [
           {
            "field": "type",
            "equals": "Microsoft.HybridCompute/machines"
           },
           {
            "field": "Microsoft.HybridCompute/imageOffer",
            "like": "windows*"
           }
          ]
         },
         {
          "allOf": [
           {
            "field": "type",
            "equals": "Microsoft.ConnectedVMwarevSphere/virtualMachines"
           },
           {
            "field": "Microsoft.ConnectedVMwarevSphere/virtualMachines/osProfile.osType",
            "like": "windows*"
           }
          ]
         }
        ]
       }
      ]
     }
    ]
   },
   "then": {
    "effect": "[parameters('effect')]",
    "details": {
     "type": "Microsoft.GuestConfiguration/guestConfigurationAssignments",
     "name": "AzureBaseline_SecurityOptionsNetworkAccess",
     "existenceCondition": {
      "allOf": [
       {
        "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/complianceStatus",
        "equals": "Compliant"
       },
       {
        "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash",
        "equals": "[base64(concat('Network access: Remotely accessible registry paths;ExpectedValue', '=', parameters('NetworkAccessRemotelyAccessibleRegistryPaths'), ',', 'Network access: Remotely accessible registry paths and sub-paths;ExpectedValue', '=', parameters('NetworkAccessRemotelyAccessibleRegistryPathsAndSubpaths'), ',', 'Network access: Shares that can be accessed anonymously;ExpectedValue', '=', parameters('NetworkAccessSharesThatCanBeAccessedAnonymously')))]"
       }
      ]
     }
    }
   }
  }
 },
 "id": "/providers/Microsoft.Authorization/policyDefinitions/3ff60f98-7fa4-410a-9f7f-0b00f5afdbdd",
 "type": "Microsoft.Authorization/policyDefinitions",
 "name": "3ff60f98-7fa4-410a-9f7f-0b00f5afdbdd"
}